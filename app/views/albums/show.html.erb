<div class="container mx-auto px-4 py-8" data-controller="album-edit lazy-loading">
  <%= turbo_stream_from @album %>
  
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white"><%= @album.name %></h1>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" id="photo-count"><%= @photos.count %> photos</p>
    </div>
    <div class="flex space-x-3">
      <%= link_to 'Back to Albums', albums_path, class: 'bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors' %>
      <button data-action="click->album-edit#toggleEditMode" 
              data-album-edit-target="editButton"
              class="bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
        Edit Album
      </button>
      <%= link_to 'Add Photo', new_album_photo_path(@album), class: 'bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors' %>
    </div>
  </div>

  <!-- Upload Status Messages -->
  <div id="upload-status"></div>

  <% if @photos.any? %>

    <!-- Photo Grid -->
    <div id="photo-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4" data-lazy-loading-target="grid">
      <% @photos.each do |photo| %>
        <% next unless photo %> <!-- Skip nil photos -->
        <%= render 'photos/photo_item', photo: photo, album: @album %>
      <% end %>
    </div>

    <!-- Loading Indicator -->
    <div data-lazy-loading-target="loading" class="py-8 text-center">
      <div class="inline-flex items-center space-x-2 hidden" id="loading-spinner">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
        <span class="text-gray-600 dark:text-gray-400">Loading more photos...</span>
      </div>
    </div>

    <!-- GLightbox JavaScript -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, checking for GLightbox...');
        
        // Check if GLightbox is available globally
        if (typeof GLightbox === 'undefined') {
          console.error('GLightbox is not loaded!');
          return;
        }
        
        console.log('GLightbox found, initializing...');
        initializeGLightbox();
      });
      
      function initializeGLightbox() {
        let lightbox = null;
        
        // Initialize GLightbox
        function createLightbox() {
          console.log('Creating GLightbox instance...');
          const elements = document.querySelectorAll('.glightbox');
          console.log('Found', elements.length, 'glightbox elements');
          
          // Log all found elements for debugging
          elements.forEach((el, index) => {
            console.log(`Element ${index + 1}:`, el.href);
          });
          
          try {
            lightbox = GLightbox({
              selector: '.glightbox',
              draggable: true,
              touchNavigation: true,
              loop: true,
              zoomable: true,
              moreLength: 0,
              skin: 'clean',
              openEffect: 'zoom',
              closeEffect: 'zoom',
              onOpen: function() {
                console.log('GLightbox opened');
              },
              onClose: function() {
                console.log('GLightbox closed');
              }
            });
            
            console.log('GLightbox initialized successfully');
          } catch (error) {
            console.error('Error initializing GLightbox:', error);
          }
        }
        
        // Initial initialization
        createLightbox();
        
        // Re-initialize when new photos are loaded
        function reinitializeLightbox() {
          console.log('Re-initializing GLightbox...');
          
          // Destroy existing instance
          if (lightbox) {
            try {
              lightbox.destroy();
              console.log('Previous GLightbox instance destroyed');
            } catch (error) {
              console.log('Error destroying GLightbox:', error);
            }
          }
          
          // Create new instance
          setTimeout(createLightbox, 50);
        }
        
        // Listen for new photos
        document.addEventListener('photos:loaded', function(event) {
          console.log('Photos loaded event received, re-initializing...');
          setTimeout(reinitializeLightbox, 100);
        });
        
        // Also listen for Turbo navigation
        document.addEventListener('turbo:load', function() {
          console.log('Turbo load event, re-initializing...');
          setTimeout(reinitializeLightbox, 100);
        });
        
        // Set up MutationObserver as backup
        const observer = new MutationObserver(function(mutations) {
          let hasNewPhotos = false;
          mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
              mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1 && node.classList && node.classList.contains('photo-item')) {
                  hasNewPhotos = true;
                }
              });
            }
          });
          
          if (hasNewPhotos) {
            console.log('MutationObserver detected new photos, re-initializing...');
            setTimeout(reinitializeLightbox, 100);
          }
        });
        
        // Start observing
        const photoGrid = document.getElementById('photo-grid');
        if (photoGrid) {
          observer.observe(photoGrid, {
            childList: true,
            subtree: true
          });
        }
      }
    </script>
  <% else %>
    <div class="text-center py-12">
      <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
      </svg>
      <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No photos yet</h3>
      <p class="text-gray-600 dark:text-gray-300 mb-4">Add your first photo to this album.</p>
      <%= link_to 'Add Photo', new_album_photo_path(@album), class: 'bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors' %>
    </div>
  <% end %>
</div>
